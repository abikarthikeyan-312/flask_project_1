{% extends "base.html" %}
{% block title %}Staff Dashboard | GNC COE{% endblock %}

{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* 1. Base Card Styling */
    .card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        overflow: hidden;
    }
    
    .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
    }

    /* 2. Stat Cards Gradients */
    .bg-gradient-blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
    .bg-gradient-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .bg-gradient-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }

    /* 3. Typography Tweaks */
    .stat-label { font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.9; }
    .stat-value { font-size: 2.25rem; font-weight: 800; line-height: 1.2; }

    /* 4. Action Buttons Grid */
    .action-btn {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding: 1.5rem; border-radius: 12px; background: white; text-decoration: none;
        color: #1e293b; border: 1px solid #e2e8f0; transition: all 0.2s; height: 100%;
        text-align: center;
    }
    .action-btn:hover { background: #f8fafc; border-color: #cbd5e1; color: #0f172a; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .action-icon { font-size: 1.75rem; margin-bottom: 0.5rem; display: block; }

    /* 5. Charts Container */
    .chart-container { position: relative; height: 80px; width: 80px; }
</style>

<div class="d-flex flex-column flex-md-row justify-content-between align-items-end mb-5 border-bottom pb-4">
    <div class="mb-3 mb-md-0">
        <h2 class="fw-bold text-dark m-0">üìä Analytics Dashboard</h2>
        <p class="text-muted m-0">Welcome back, {{ session.username }}! Here's your activity overview.</p>
    </div>

    <form class="d-flex gap-2 flex-wrap justify-content-end" method="GET">
        <select name="school_id" class="form-select form-select-sm bg-light border-0 fw-bold" style="width: 140px;" onchange="this.form.submit()">
            <option value="">üè´ All Schools</option>
            {% for s in schools %}
            <option value="{{ s.id }}" {% if sel_school == s.id %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
        </select>

        <select name="department_id" class="form-select form-select-sm bg-light border-0 fw-bold" style="width: 150px;" onchange="this.form.submit()">
            <option value="">üè¢ All Depts</option>
            {% for d in departments %}
            <option value="{{ d.id }}" {% if sel_dept == d.id %}selected{% endif %}>{{ d.name }}</option>
            {% endfor %}
        </select>

        <select name="subject_version_id" class="form-select form-select-sm bg-light border-0 fw-bold" style="width: 140px;" onchange="this.form.submit()">
            <option value="">üìò All Subjects</option>
            {% for sub in subjects %}
            <option value="{{ sub.name}}" {% if sel_subject == sub.name %}selected{% endif %}>{{ sub.subject.name }} ({{ sub.subject.code }})</option>
            {% endfor %}
        </select>

        {% if sel_school or sel_dept or sel_subject %}
        <a href="{{ url_for('staff.staff_home') }}" class="btn btn-sm btn-secondary fw-bold px-3">‚úñ Reset</a>
        {% endif %}
    </form>
</div>

<div class="row g-3 mb-5">
    <div class="col-6 col-md-3">
        <a href="{{ url_for('staff.generate_paper_entry') }}" class="action-btn shadow-sm text-primary">
            <span class="action-icon">üìÑ</span>
            <span class="fw-bold">Generate Paper</span>
        </a>
    </div>
    <div class="col-6 col-md-3">
        <a href="{{ url_for('staff.scrutiny_list') }}" class="action-btn shadow-sm text-warning position-relative">
            <span class="action-icon">üîç</span>
            <span class="fw-bold">Scrutiny Review</span>
            {% if stats.get('UNDER_SCRUTINY', 0) > 0 %}
            <span class="position-absolute top-0 end-0 translate-middle badge rounded-pill bg-danger m-3">
                {{ stats.get('UNDER_SCRUTINY', 0) }}
            </span>
            {% endif %}
        </a>
    </div>
    <div class="col-6 col-md-3">
        <a href="{{ url_for('staff.all_generated_papers') }}" class="action-btn shadow-sm text-primary">
            <span class="action-icon">üìÇ</span>
            <span class="fw-bold">Papers Archive</span>
        </a>
    </div>
    
    <div class="col-6 col-md-3">
        <a href="{{ url_for('staff.view_question_items') }}" class="action-btn shadow-sm text-info">
            <span class="action-icon">üóÇÔ∏è</span>
            <span class="fw-bold">Questions Repository</span>
        </a>
    </div>
    <div class="col-6 col-md-3">
        <a href="{{ url_for('staff.my_subjects') }}" class="action-btn shadow-sm text-success">
            <span class="action-icon">üìö</span>
            <span class="fw-bold">My Subjects</span>
        </a>
    </div>

    <div class="col-6 col-md-3">
        <a href="{{ url_for('staff.view_weightage') }}" class="action-btn shadow-sm text-purple" style="color: #6f42c1;">
            <span class="action-icon">‚öñÔ∏è</span>
            <span class="fw-bold">My Weightages</span>
        </a>
    </div>
    <div class="col-6 col-md-3">
        <a href="{{ url_for('staff.view_patterns') }}" class="action-btn shadow-sm text-dark">
            <span class="action-icon">üìù</span>
            <span class="fw-bold">View Patterns</span>
        </a>
    </div>
    <div class="col-6 col-md-3">
    <div class="action-btn shadow-sm bg-light text-muted" style="cursor: default; flex-direction: row; gap: 1rem;">
        
        <div class="text-center flex-grow-1">
            <span class="fw-bold d-block text-uppercase small ls-1">Active Papers</span>
            <span class="display-6 fw-bold text-success">{{ stats.get('ACTIVE', 0) }}</span>
        </div>

    </div>
    </div>
</div>


<hr style="border: 0.2px solid #8d8b8b; margin: 20px 0;">

<div class="row g-4 mb-5">
    
    <div class="col-md-4">
        <div class="card h-100 p-4 bg-white">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <div class="stat-label text-muted">Total Papers</div>
                    <div class="stat-value text-dark">{{ total_papers }}</div>
                </div>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            
            <div class="d-flex justify-content-between mt-auto pt-3 border-top">
                <div class="text-center">
                    <div class="h5 fw-bold mb-0 text-warning">{{ stats.get('GENERATED', 0) }}</div>
                    <small class="text-muted fw-bold" style="font-size: 0.7rem;">DRAFTS</small>
                </div>
                <div class="text-center border-start border-end px-3">
                    <div class="h5 fw-bold mb-0 text-info">{{ stats.get('UNDER_SCRUTINY', 0) }}</div>
                    <small class="text-muted fw-bold" style="font-size: 0.7rem;">SCRUTINY</small>
                </div>
                <div class="text-center">
                    <div class="h5 fw-bold mb-0 text-success">{{ stats.get('ACTIVE', 0) }}</div>
                    <small class="text-muted fw-bold" style="font-size: 0.7rem;">ACTIVE</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100 p-4 bg-gradient-blue border-0">
            <div class="d-flex flex-column h-100 justify-content-between">
                <div>
                    <div class="stat-label text-white-50">Bank Storage</div>
                    <div class="stat-value mb-1">{{ total_banks }} <span class="fs-6 fw-normal text-white-50">Uploads</span></div>
                </div>
                <div class="mt-3">
                    <div class="display-6 fw-bold">{{ total_bank_questions }}</div>
                    <div class="text-white-50 small fw-bold text-uppercase">Total Questions Available</div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100 p-4 bg-white">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <div class="stat-label text-muted">Utilization</div>
                    <div class="stat-value text-success">{{ total_paper_questions }}</div>
                    <div class="small text-muted fw-bold mt-1">Questions Consumed</div>
                </div>
                <div class="chart-container">
                    <canvas id="utilChart"></canvas>
                </div>
            </div>
            <div class="mt-3 small text-muted">
                You have used <strong>{{ total_paper_questions }}</strong> out of <strong>{{ total_bank_questions }}</strong> available questions.
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header bg-white py-3 border-bottom d-flex align-items-center justify-content-between">
        <h6 class="mb-0 fw-bold text-uppercase ls-1">üöÄ Recently Activated Papers</h6>
    </div>
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light text-muted small text-uppercase">
                <tr>
                    <th class="ps-4 py-3">Paper Code</th>
                    <th class="py-3">Subject</th>
                    <th class="py-3">Date</th>
                    <th class="text-end pe-4 py-3">Official Document</th>
                    <th class="text-end pe-4 py-3">Students Document</th>
                </tr>
            </thead>
            <tbody>
                {% for paper in active_papers %}
                <tr>
                    <td class="ps-4">
                        <span class="fw-bold text-dark">{{ paper.paper_code }}</span>
                    </td>
                    <td>
                        <div class="fw-bold text-dark">{{ paper.subject_version.subject.name }}</div>
                        <div class="small text-muted">{{ paper.subject_version.subject.code }}</div>
                    </td>
                    <td>
                        <span class="badge bg-light text-dark border fw-normal">
                            {{ paper.last_modified_at.strftime('%d %b %Y') }}
                        </span>
                    </td>
                    <td class="text-end pe-4">
                        <div class="btn-group">
                            <a href="{{ url_for('staff.download_official_question_paper', paper_id=paper.id) }}" 
                               class="btn btn-sm btn-outline-secondary" 
                               title="Download Official Doc">
                                üéì Official
                            </a>
                        </div>
                    </td> 
                    <td class="text-end pe-4">
                        <div class="btn-group">
                            <a href="{{ url_for('staff.download_question_paper', paper_id=paper.id) }}" 
                               class="btn btn-sm btn-outline-secondary" 
                               title="Download Student Doc">
                                üè¢Student
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center py-5">
                        <div class="text-muted mb-2">No active papers found</div>
                        <a href="{{ url_for('staff.scrutiny_list') }}" class="btn btn-sm btn-primary">Go to Scrutiny to Activate Papers</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // Common Chart Options
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '75%',
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        animation: { duration: 1000, easing: 'easeOutQuart' }
    };

    // 1. STATUS CHART (Doughnut)
    new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: ['Draft', 'Scrutiny', 'Active'],
            datasets: [{
                data: [{{ stats.get('GENERATED', 0) }}, {{ stats.get('UNDER_SCRUTINY', 0) }}, {{ stats.get('ACTIVE', 0) }}],
                backgroundColor: ['#ffc107', '#0dcaf0', '#198754'],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: chartOptions
    });

    // 2. UTILIZATION CHART (Doughnut)
    new Chart(document.getElementById('utilChart'), {
        type: 'doughnut',
        data: {
            labels: ['Used', 'Unused'],
            datasets: [{
                // FIX: Ensure calculation doesn't go negative if repetitions cause used > available
                data: [{{ total_paper_questions }}, {{ (total_bank_questions - total_paper_questions) if total_bank_questions > total_paper_questions else 0 }}],
                backgroundColor: ['#10b981', '#e2e8f0'],
                borderWidth: 0,
                hoverOffset: 5
            }]
        },
        options: chartOptions
    });
</script>

{% endblock %}