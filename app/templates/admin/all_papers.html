{% extends "base.html" %}
{% block content %}

<style>
/* ---------- PAGE LAYOUT ---------- */
.repo-container{
    height: calc(100vh - 170px);
    display:flex;
    flex-direction:column;
}

/* ---------- TABLE SCROLL AREA ---------- */
.table-scroll{
    flex:1;
    overflow-y:auto;
}

/* custom scrollbar */
.table-scroll::-webkit-scrollbar{
    width:8px;
}
.table-scroll::-webkit-scrollbar-thumb{
    background:#cfd4da;
    border-radius:10px;
}
.table-scroll::-webkit-scrollbar-thumb:hover{
    background:#adb5bd;
}

/* sticky header */
thead th{
    position:sticky;
    top:0;
    z-index:5;
    background:white !important;
    box-shadow: 0 1px 0 #dee2e6;
}

/* nicer table hover */
.table-hover tbody tr:hover{
    background:#f7fbff;
    transition:.15s;
}

/* Column Separators */
.table-bordered > :not(caption) > * > * {
    border-width: 1px;
}

/* ---------- MODAL STYLES (Added) ---------- */
.modal {
    display: none; 
    position: fixed; 
    z-index: 1000; 
    left: 0;
    top: 0;
    width: 100%; 
    height: 100%; 
    overflow: auto; 
    background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
    align-items: center;
    justify-content: center;
}

.modal.show {
    display: flex !important;
}

.modal-content {
    background-color: #fefefe;
    padding: 20px;
    border: 1px solid #888;
    width: 400px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    text-align: center;
}

.modal-btns {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 10px;
}
</style>

<div class="d-flex flex-column flex-md-row justify-content-between align-items-end mb-3 border-bottom pb-2">
    <div>
        <h3 class="fw-bold m-0">üóÇÔ∏è Paper Archive (Admin)</h3>
        <p class="text-muted small m-0">Manage all generated question papers.</p>
    </div>

    <form class="d-flex gap-2 flex-wrap justify-content-end" method="GET">
        <select name="school_id" class="form-select form-select-sm bg-light fw-bold" style="width:140px;" onchange="this.form.submit()">
            <option value="">üè´ All Schools</option>
            {% for s in schools %}
            <option value="{{ s.id }}" {% if sel_school == s.id %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
        </select>

        <select name="department_id" class="form-select form-select-sm bg-light fw-bold" style="width:150px;" onchange="this.form.submit()">
            <option value="">üè¢ All Depts</option>
            {% for d in departments %}
            <option value="{{ d.id }}" {% if sel_dept == d.id %}selected{% endif %}>{{ d.name }}</option>
            {% endfor %}
        </select>

        <select name="batch" class="form-select form-select-sm bg-light fw-bold" style="width:100px;" onchange="this.form.submit()">
            <option value="">üìÖ Batch</option>
            {% for b in batches %}
            <option value="{{ b }}" {% if sel_batch == b %}selected{% endif %}>{{ b }}</option>
            {% endfor %}
        </select>

        <select name="subject_version_id" class="form-select form-select-sm bg-light fw-bold" style="width:140px;" onchange="this.form.submit()">
            <option value="">üìò All Subjects</option>
            {% for sub in subjects %}
            <option value="{{ sub.id }}" {% if sel_subject == sub.id %}selected{% endif %}>
                {{ sub.subject.code }}
            </option>
            {% endfor %}
        </select>

        {% if sel_school or sel_dept or sel_subject or sel_batch %}
        <a href="{{ url_for('admin.all_generated_papers') }}" class="btn btn-sm btn-secondary fw-bold">‚úñ</a>
        {% endif %}
    </form>
</div>

<div class="card shadow-sm border-0 repo-container">

    <div class="card-header bg-light p-2 border-bottom">
        <form method="GET" class="d-flex gap-2 align-items-center flex-wrap">
            <input type="hidden" name="school_id" value="{{ sel_school or '' }}">
            <input type="hidden" name="department_id" value="{{ sel_dept or '' }}">
            <input type="hidden" name="subject_version_id" value="{{ sel_subject or '' }}">
            <input type="hidden" name="batch" value="{{ sel_batch or '' }}">

            <span class="fw-bold text-muted small ms-2 me-1">FILTER:</span>

            <select name="status" class="form-select form-select-sm border-secondary" style="width:130px;" onchange="this.form.submit()">
                <option value="">All Status</option>
                {% for s in ['GENERATED', 'UNDER_SCRUTINY', 'ACTIVE', 'ARCHIVED'] %}
                <option value="{{ s }}" {% if sel_status == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>

            <select name="paper_type" class="form-select form-select-sm border-secondary" style="width:130px;" onchange="this.form.submit()">
                <option value="">All Types</option>
                {% for t in ['NORMAL', 'SUPPLEMENTARY', 'REVALUATION'] %}
                <option value="{{ t }}" {% if sel_type == t %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
            </select>

            <div class="ms-auto">
                <span class="badge bg-dark">Total: {{ total_count }}</span>
            </div>
        </form>
    </div>

    <div class="table-scroll">
        <table class="table table-bordered table-hover mb-0" style="font-size:.85rem;">
            <thead class="align-middle text-center">
                <tr>
                    <th style="min-width:200px;">Subject Name (Code)</th>
                    <th style="width:80px;">Batch</th>
                    <th style="width:120px;">Paper Code</th>
                    <th style="width:100px;">Type</th>
                    <th style="width:120px;">Status</th>
                    <th style="width:120px;">Created By</th>
                    <th style="width:100px;">Last Modified</th>
                    <th style="width:100px;">Official</th>
                    <th style="width:100px;">Student</th>
                    <th style="width:80px;" class="bg-danger text-white">Delete</th>
                </tr>
            </thead>
            <tbody class="align-middle">
                {% for p in papers %}
                <tr>
                    <td>
                        <div class="fw-bold text-dark">{{ p.subject_version.subject.name }}</div>
                        <small class="text-muted">({{ p.subject_version.subject.code }})</small>
                    </td>

                    <td class="text-center fw-bold">{{ p.subject_version.batch }}</td>

                    <td class="text-center fw-bold text-primary">{{ p.paper_code }}</td>

                    <td class="text-center">
                        <span class="badge bg-light text-dark border border-secondary">{{ p.paper_type }}</span>
                    </td>

                    <td class="text-center">
                        {% if p.status == 'ACTIVE' %}
                            <span class="badge bg-success">ACTIVE</span>
                        {% elif p.status == 'UNDER_SCRUTINY' %}
                            <span class="badge bg-warning text-dark">SCRUTINY</span>
                        {% elif p.status == 'ARCHIVED' %}
                            <span class="badge bg-secondary">ARCHIVED</span>
                        {% else %}
                            <span class="badge bg-danger">DRAFT</span>
                        {% endif %}
                    </td>

                    <td class="text-center">
                        <span class="small text-muted">üë§ {{ p.creator.username }}</span>
                    </td>

                    <td class="text-center small text-muted">
                        {{ p.last_modified_at.strftime('%Y-%m-%d') }}
                    </td>

                    <td class="text-center">
                        <a href="{{ url_for('admin.download_official_paper', paper_id=p.id) }}" 
                           class="btn btn-sm btn-outline-success border-0 fw-bold" 
                           title="Download Official Format">
                           ‚¨á Official
                        </a>
                    </td>

                    <td class="text-center">
                        <a href="{{ url_for('admin.download_student_paper', paper_id=p.id) }}" 
                           class="btn btn-sm btn-outline-primary border-0 fw-bold" 
                           title="Download Student/Draft Format">
                           ‚¨á Student
                        </a>
                    </td>

                    <td class="text-center">
                        <form action="{{ url_for('admin.delete_paper') }}" method="POST" 
                              onsubmit="handleDelete(event, '{{ p.paper_code }}')">
                            <input type="hidden" name="paper_id" value="{{ p.id }}">
                            <button type="submit" class="btn btn-sm btn-danger fw-bold py-0">
                                ‚úñ
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="10" class="text-center py-5 text-muted fw-bold">
                        No question papers found matching filters.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card-footer bg-light py-1 text-center small text-muted border-top">
        Showing {{ papers|length }} records
    </div>

</div>

<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h4 class="text-danger fw-bold">‚ö†Ô∏è Delete Confirmation</h4>
        <p id="deleteMessage" class="mt-3 text-muted" style="font-size: 1.1em;"></p>
        
        <div class="modal-btns">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button id="confirmDeleteBtn" class="btn btn-danger fw-bold">Yes, Delete</button>
        </div>
    </div>
</div>

<script>
    let formToSubmit = null; // Store the form element temporarily

    function handleDelete(event, paperCode) {
        event.preventDefault(); // Stop immediate submission
        formToSubmit = event.target; // Save the form

        // Update modal message
        const msg = `Are you sure you want to PERMANENTLY delete paper "${paperCode}"?\n\nThis action cannot be undone.`;
        document.getElementById("deleteMessage").innerText = msg;

        // Show modal
        const modal = document.getElementById("deleteModal");
        modal.classList.add("show");
    }

    // Confirm Button Click
    document.getElementById("confirmDeleteBtn").onclick = function() {
        if (formToSubmit) {
            formToSubmit.submit(); // Actually submit the form now
        }
    };

    function closeModal() {
        document.getElementById("deleteModal").classList.remove("show");
        formToSubmit = null;
    }

    // Close modal if clicking outside box
    window.onclick = function(event) {
        const modal = document.getElementById("deleteModal");
        if (event.target == modal) {
            closeModal();
        }
    }
</script>

{% endblock %}