{% extends "base.html" %}
{% block content %}

<style>
/* ---------- PAGE LAYOUT ---------- */
.repo-container{
    height: calc(100vh - 170px);
    display:flex;
    flex-direction:column;
}

/* ---------- TABLE SCROLL AREA ---------- */
.table-scroll{
    flex:1;
    overflow-y:auto;
}

/* custom scrollbar */
.table-scroll::-webkit-scrollbar{
    width:8px;
}
.table-scroll::-webkit-scrollbar-thumb{
    background:#cfd4da;
    border-radius:10px;
}
.table-scroll::-webkit-scrollbar-thumb:hover{
    background:#adb5bd;
}

/* sticky header */
thead th{
    position:sticky;
    top:0;
    z-index:5;
    background:white !important;
    box-shadow: 0 1px 0 #dee2e6;
}

/* nicer table hover */
.table-hover tbody tr:hover{
    background:#f7fbff;
    transition:.15s;
}

/* Column Separators */
.table-bordered > :not(caption) > * > * {
    border-width: 1px;
}
</style>

<div class="d-flex flex-column flex-md-row justify-content-between align-items-end mb-3 border-bottom pb-2">
    <div>
        <h3 class="fw-bold m-0">üóÉÔ∏è Master Question Archive</h3>
        <p class="text-muted small m-0">Manage individual unique questions.</p>
    </div>

    <form class="d-flex gap-2 flex-wrap justify-content-end" method="GET">
        <select name="school_id" class="form-select form-select-sm bg-light fw-bold" style="width:140px;" onchange="this.form.submit()">
            <option value="">üè´ All Schools</option>
            {% for s in schools %}
            <option value="{{ s.id }}" {% if sel_school == s.id %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
        </select>

        <select name="department_id" class="form-select form-select-sm bg-light fw-bold" style="width:150px;" onchange="this.form.submit()">
            <option value="">üè¢ All Depts</option>
            {% for d in departments %}
            <option value="{{ d.id }}" {% if sel_dept == d.id %}selected{% endif %}>{{ d.name }}</option>
            {% endfor %}
        </select>

        <select name="batch" class="form-select form-select-sm bg-light fw-bold" style="width:100px;" onchange="this.form.submit()">
            <option value="">üìÖ Batch</option>
            {% for b in batches %}
            <option value="{{ b }}" {% if sel_batch == b %}selected{% endif %}>{{ b }}</option>
            {% endfor %}
        </select>

        <select name="subject_version_id" class="form-select form-select-sm bg-light fw-bold" style="width:140px;" onchange="this.form.submit()">
            <option value="">üìò All Subjects</option>
            {% for sub in subjects %}
            <option value="{{ sub.id }}" {% if sel_subject == sub.id %}selected{% endif %}>
                {{ sub.subject.code }}
            </option>
            {% endfor %}
        </select>

        {% if sel_school or sel_dept or sel_subject or sel_batch %}
        <a href="{{ url_for('admin.all_questions') }}" class="btn btn-sm btn-secondary fw-bold">‚úñ</a>
        {% endif %}
    </form>
</div>

<div class="card shadow-sm border-0 repo-container">

    <div class="card-header bg-light p-2 border-bottom">
        <form method="GET" class="d-flex gap-2 align-items-center flex-wrap">
            <input type="hidden" name="school_id" value="{{ sel_school or '' }}">
            <input type="hidden" name="department_id" value="{{ sel_dept or '' }}">
            <input type="hidden" name="subject_version_id" value="{{ sel_subject or '' }}">
            <input type="hidden" name="batch" value="{{ sel_batch or '' }}">

            <span class="fw-bold text-muted small ms-2 me-1">FILTER:</span>

            <select name="unit" class="form-select form-select-sm border-secondary" style="width:100px;" onchange="this.form.submit()">
                <option value="">Unit</option>
                {% for i in range(1,6) %}
                <option value="{{ i }}" {% if sel_unit == i %}selected{% endif %}>Unit {{ i }}</option>
                {% endfor %}
            </select>

            <select name="marks" class="form-select form-select-sm border-secondary" style="width:100px;" onchange="this.form.submit()">
                <option value="">Marks</option>
                {% for m in [1,2,3,5,6,7,8,9,10,15,20] %}
                <option value="{{ m }}" {% if sel_marks == m %}selected{% endif %}>{{ m }}</option>
                {% endfor %}
            </select>

            <select name="k_level" class="form-select form-select-sm border-secondary" style="width:100px;" onchange="this.form.submit()">
                <option value="">K-Level</option>
                {% for k in ['K1','K2','K3','K4','K5','K6'] %}
                <option value="{{ k }}" {% if sel_klevel == k %}selected{% endif %}>{{ k }}</option>
                {% endfor %}
            </select>

            <div class="ms-auto">
                <span class="badge bg-dark">Total: {{ total_count }}</span>
            </div>
        </form>
    </div>

    <div class="table-scroll">
        <table class="table table-bordered table-hover mb-0" style="font-size:.85rem;">
            <thead class="align-middle text-center">
                <tr>
                    <th style="width:60px;">ID</th>
                    <th style="min-width:200px;">Subject Name (Code)</th>
                    <th>Question Text</th>
                    <th style="width:60px;">Unit</th>
                    <th style="width:60px;">Sec</th>
                    <th style="width:60px;">Marks</th>
                    <th style="width:80px;">K-Lvl</th>
                    <th style="width:110px;">Created</th>
                    <th style="width:70px;" class="bg-danger text-white">Del</th>
                </tr>
            </thead>
            <tbody class="align-middle">
                {% for q in questions %}
                <tr>
                    <td class="text-center text-muted fw-bold">#{{ q.id }}</td>

                    <td>
                        <div class="fw-bold text-dark">{{ q.subject.name }}</div>
                        <small class="text-muted">({{ q.subject.code }})</small>
                    </td>

                    <td style="min-width:350px;">
                        {{ q.question_text }}
                    </td>

                    <td class="text-center fw-bold">{{ q.default_unit if q.default_unit else '-' }}</td>

                    <td class="text-center fw-bold">{{ q.default_section if q.default_section else '-' }}</td>

                    <td class="text-center">{{ q.default_marks if q.default_marks else '-' }}</td>

                    <td class="text-center">
                        {% if q.k_level %}
                        <span class="badge bg-info text-dark border border-secondary" style="font-size:0.7em">{{ q.k_level }}</span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>

                    <td class="text-center small text-muted">
                        {{ q.created_at.strftime('%Y-%m-%d') }}
                    </td>

                    <td class="text-center">
                        <form action="{{ url_for('admin.delete_question') }}" method="POST" 
                              onsubmit="return confirm('‚ö†Ô∏è WARNING: Deleting this Master Question might affect existing Banks/Papers if they are not active.\n\nAre you sure?\n **Note** If the Question Bank for that purticular subject is present you cant delete the question');">
                            <input type="hidden" name="question_id" value="{{ q.id }}">
                            <button type="submit" class="btn btn-sm btn-danger fw-bold py-0">‚úñ</button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="text-center py-5 text-muted fw-bold">
                        No questions found matching filters.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card-footer bg-light py-1 text-center small text-muted border-top">
        Showing {{ questions|length }} records
    </div>

</div>

{% endblock %}