{% extends "base.html" %}
{% block title %}Manage Schools{% endblock %}

{% block content %}

<style>
    /* Modal Overlay */
    .modal {
        display: none; 
        position: fixed; 
        z-index: 1050; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.5); 
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex !important;
    }

    /* Modal Content */
    .modal-content {
        background-color: #fff;
        padding: 25px;
        border: 1px solid #888;
        width: 450px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        text-align: center;
    }

    .modal-header {
        font-size: 1.25rem;
        font-weight: bold;
        margin-bottom: 15px;
    }

    .modal-body {
        font-size: 1rem;
        color: #555;
        margin-bottom: 25px;
    }

    .modal-footer {
        display: flex;
        justify-content: center;
        gap: 15px;
    }
</style>

<h1>üè´ Manage Schools</h1>

<div class="grid-2">

    <div class="card">
        <h3>Add New School</h3>
        <form method="POST">
            <input name="name" placeholder="e.g. School of Information Technology" required>
            <button>Add School</button>
        </form>
    </div>

    <div class="card">
        <h3>Existing Schools</h3>

        <div class="table-card">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                    </tr>
                </thead>
                <tbody>
                    {% for school in schools %}
                    <tr>
                        <td>{{ school.id }}</td>
                        <td>{{ school.name }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div style="display:flex; justify-content:space-between; align-items:center;">

                    <a href="{{ url_for('admin.download_schools_csv') }}">
                        <button type="button">‚¨á Download CSV</button>
                    </a>
            </div>
        </div>
    </div>
</div>

<hr>

<div class="card">
    <h3>üóë Delete School</h3>

    <select id="schoolSelect">
        <option value="">Select School...</option>
        {% for school in schools %}
            <option value="{{ school.id }}">{{ school.name }}</option>
        {% endfor %}
    </select>

    <button type="button" onclick="deleteSchool()">Delete School</button>
</div>

<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div id="modalTitle" class="modal-header"></div>
        <div id="modalMessage" class="modal-body"></div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button type="button" id="confirmDeleteBtn" class="btn btn-danger fw-bold" style="display:none;">Yes, Delete</button>
        </div>
    </div>
</div>

<script>
// Global variable to store the ID pending deletion
let pendingSchoolId = null;

function deleteSchool() {
    const schoolId = document.getElementById("schoolSelect").value;
    const titleEl = document.getElementById("modalTitle");
    const msgEl = document.getElementById("modalMessage");
    const confirmBtn = document.getElementById("confirmDeleteBtn");

    // 1. Validation: No School Selected
    if (!schoolId) {
        titleEl.className = "modal-header text-warning";
        titleEl.innerText = "‚ö†Ô∏è Selection Required";
        msgEl.innerText = "Please select a school from the dropdown list.";
        confirmBtn.style.display = "none"; // Hide delete button
        openModal();
        return;
    }

    // 2. Check Backend Validation
    fetch(`/admin/schools/check-delete/${schoolId}`)
        .then(res => res.json())
        .then(data => {
            if (!data.can_delete) {
                // Validation Error (Cannot Delete)
                titleEl.className = "modal-header text-danger";
                titleEl.innerText = "üö´ Cannot Delete";
                msgEl.innerText = data.message; // Show backend error message
                confirmBtn.style.display = "none";
            } else {
                // Success: Ask for Confirmation
                titleEl.className = "modal-header text-danger";
                titleEl.innerText = "‚ö†Ô∏è Confirm Deletion";
                msgEl.innerHTML = "Are you sure you want to delete this school?<br><br><strong>This action cannot be undone.</strong>";
                
                confirmBtn.style.display = "block"; // Show delete button
                pendingSchoolId = schoolId; // Store ID for the confirm button
            }
            openModal();
        });
}

// Button Click Handler for "Yes, Delete"
document.getElementById("confirmDeleteBtn").onclick = function() {
    if (pendingSchoolId) {
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "/admin/schools/delete";

        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "school_id";
        input.value = pendingSchoolId;

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
};

// --- Modal Helpers ---
function openModal() {
    document.getElementById("deleteModal").classList.add("show");
}

function closeModal() {
    document.getElementById("deleteModal").classList.remove("show");
    pendingSchoolId = null;
}

// Close modal if clicking outside
window.onclick = function(event) {
    const modal = document.getElementById("deleteModal");
    if (event.target == modal) {
        closeModal();
    }
}
</script>
{% endblock %}