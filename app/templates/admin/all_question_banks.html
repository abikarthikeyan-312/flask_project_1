{% extends "base.html" %}
{% block content %}

<style>
/* ---------- PAGE LAYOUT ---------- */
.repo-container{
    height: calc(100vh - 170px);
    display:flex;
    flex-direction:column;
}

/* ---------- TABLE SCROLL AREA ---------- */
.table-scroll{
    flex:1;
    overflow-y:auto;
}

/* custom scrollbar */
.table-scroll::-webkit-scrollbar{
    width:8px;
}
.table-scroll::-webkit-scrollbar-thumb{
    background:#cfd4da;
    border-radius:10px;
}
.table-scroll::-webkit-scrollbar-thumb:hover{
    background:#adb5bd;
}

/* sticky header */
thead th{
    position:sticky;
    top:0;
    z-index:5;
    background:white !important;
    box-shadow: 0 1px 0 #dee2e6;
}

/* nicer table hover */
.table-hover tbody tr:hover{
    background:#f7fbff;
    transition:.15s;
}

/* Column Separators */
.table-bordered > :not(caption) > * > * {
    border-width: 1px;
}

/* ---------- MODAL STYLES (Added) ---------- */
.modal {
    display: none; 
    position: fixed; 
    z-index: 1000; 
    left: 0;
    top: 0;
    width: 100%; 
    height: 100%; 
    overflow: auto; 
    background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
    align-items: center;
    justify-content: center;
}

.modal.show {
    display: flex !important;
}

.modal-content {
    background-color: #fefefe;
    padding: 20px;
    border: 1px solid #888;
    width: 400px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    text-align: center;
}

.modal-btns {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 10px;
}
</style>

<div class="d-flex flex-column flex-md-row justify-content-between align-items-end mb-3 border-bottom pb-2">
    <div>
        <h3 class="fw-bold m-0">üóÑÔ∏è Question Bank Archive</h3>
        <p class="text-muted small m-0">Manage all uploaded question banks.</p>
    </div>

    <form class="d-flex gap-2 flex-wrap justify-content-end" method="GET">
        <select name="school_id" class="form-select form-select-sm bg-light fw-bold" style="width:140px;" onchange="this.form.submit()">
            <option value="">üè´ All Schools</option>
            {% for s in schools %}
            <option value="{{ s.id }}" {% if sel_school == s.id %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
        </select>

        <select name="department_id" class="form-select form-select-sm bg-light fw-bold" style="width:150px;" onchange="this.form.submit()">
            <option value="">üè¢ All Depts</option>
            {% for d in departments %}
            <option value="{{ d.id }}" {% if sel_dept == d.id %}selected{% endif %}>{{ d.name }}</option>
            {% endfor %}
        </select>

        <select name="batch" class="form-select form-select-sm bg-light fw-bold" style="width:100px;" onchange="this.form.submit()">
            <option value="">üìÖ Batch</option>
            {% for b in batches %}
            <option value="{{ b }}" {% if sel_batch == b %}selected{% endif %}>{{ b }}</option>
            {% endfor %}
        </select>

        <select name="subject_version_id" class="form-select form-select-sm bg-light fw-bold" style="width:140px;" onchange="this.form.submit()">
            <option value="">üìò All Subjects</option>
            {% for sub in subjects %}
            <option value="{{ sub.id }}" {% if sel_subject == sub.id %}selected{% endif %}>
                {{ sub.subject.code }}
            </option>
            {% endfor %}
        </select>

        {% if sel_school or sel_dept or sel_subject or sel_batch %}
        <a href="{{ url_for('admin.all_question_banks') }}" class="btn btn-sm btn-secondary fw-bold">‚úñ</a>
        {% endif %}
    </form>
</div>

<div class="card shadow-sm border-0 repo-container">

    <div class="card-header bg-light p-2 border-bottom">
        <form method="GET" class="d-flex gap-2 align-items-center flex-wrap">
            <input type="hidden" name="school_id" value="{{ sel_school or '' }}">
            <input type="hidden" name="department_id" value="{{ sel_dept or '' }}">
            <input type="hidden" name="subject_version_id" value="{{ sel_subject or '' }}">
            <input type="hidden" name="batch" value="{{ sel_batch or '' }}">

            <span class="fw-bold text-muted small ms-2 me-1">FILTER:</span>

            <select name="status" class="form-select form-select-sm border-secondary" style="width:130px;" onchange="this.form.submit()">
                <option value="">All Status</option>
                {% for s in ['ACTIVE', 'ARCHIVED'] %}
                <option value="{{ s }}" {% if sel_status == s %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>

            <select name="is_default" class="form-select form-select-sm border-secondary" style="width:130px;" onchange="this.form.submit()">
                <option value="">Default?</option>
                <option value="1" {% if sel_default == '1' %}selected{% endif %}>YES</option>
                <option value="0" {% if sel_default == '0' %}selected{% endif %}>NO</option>
            </select>

            <div class="ms-auto">
                <span class="badge bg-dark">Total: {{ total_count }}</span>
            </div>
        </form>
    </div>

    <div class="table-scroll">
        <table class="table table-bordered table-hover mb-0" style="font-size:.85rem;">
            <thead class="align-middle text-center">
                <tr>
                    <th style="min-width:200px;">Subject Name (Code)</th>
                    <th style="width:80px;">Batch</th>
                    <th style="width:70px;">Ver.</th>
                    <th style="width:100px;">Status</th>
                    <th style="width:100px;">Is Default</th>
                    <th style="width:150px;">Uploaded By</th>
                    <th style="width:150px;">Uploaded At</th>
                    <th style="width:80px;" class="bg-danger text-white">Delete</th>
                </tr>
            </thead>
            <tbody class="align-middle">
                {% for q in banks %}
                <tr>
                    <td>
                        <div class="fw-bold text-dark">{{ q.subject_version.subject.name }}</div>
                        <small class="text-muted">({{ q.subject_version.subject.code }})</small>
                    </td>

                    <td class="text-center fw-bold">{{ q.subject_version.batch }}</td>

                    <td class="text-center fw-bold text-primary">v{{ q.version_no }}</td>

                    <td class="text-center">
                        {% if q.status == 'ACTIVE' %}
                            <span class="badge bg-success">ACTIVE</span>
                        {% else %}
                            <span class="badge bg-secondary">ARCHIVED</span>
                        {% endif %}
                    </td>

                    <td class="text-center">
                        {% if q.is_default %}
                            <span class="badge bg-primary">DEFAULT</span>
                        {% else %}
                            <span class="text-muted small">-</span>
                        {% endif %}
                    </td>

                    <td class="text-center">
                        <span class="small text-muted">üë§ {{ q.uploaded_by }}</span> 
                        </td>

                    <td class="text-center small text-muted">
                        {{ q.uploaded_at.strftime('%d-%b-%Y %I:%M %p') }}
                    </td>

                    <td class="text-center">
                        <form action="{{ url_for('admin.delete_question_bank') }}" method="POST">
                            <input type="hidden" name="bank_id" value="{{ q.id }}">
                            <button type="button" class="btn btn-sm btn-danger fw-bold py-0"
                                    onclick="triggerDelete(this)">
                                ‚úñ
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center py-5 text-muted fw-bold">
                        No question banks found matching filters.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="card-footer bg-light py-1 text-center small text-muted border-top">
        Showing {{ banks|length }} records
    </div>

</div>

<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h4 class="text-danger fw-bold">‚ö†Ô∏è Delete Confirmation</h4>
        <p class="mt-3 text-muted" style="font-size: 1.1em;">
            Are you sure you want to PERMANENTLY delete this Question Bank and ALL its questions?
            <br><br>
            <span class="text-danger fw-bold">This action cannot be undone.</span>
        </p>
        
        <div class="modal-btns">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="button" id="confirmDeleteBtn" class="btn btn-danger fw-bold">Yes, Delete</button>
        </div>
    </div>
</div>

<script>
    // Global variable to hold the form we want to delete
    let formToSubmit = null; 

    function triggerDelete(btnElement) {
        // 1. Find the parent form of the clicked button
        formToSubmit = btnElement.closest('form');
        
        if (formToSubmit) {
            // 2. Show the modal
            document.getElementById("deleteModal").classList.add("show");
        } else {
            console.error("Error: Could not find the form associated with the delete button.");
        }
    }

    // "Yes, Delete" Button Click Handler
    document.getElementById("confirmDeleteBtn").onclick = function() {
        if (formToSubmit) {
            // ‚úÖ ROBUST SUBMIT: Use prototype call to avoid naming collisions
            HTMLFormElement.prototype.submit.call(formToSubmit);
            
            closeModal();
        }
    };

    function closeModal() {
        document.getElementById("deleteModal").classList.remove("show");
        formToSubmit = null;
    }

    // Close modal if clicking outside the white box
    window.onclick = function(event) {
        const modal = document.getElementById("deleteModal");
        if (event.target == modal) {
            closeModal();
        }
    }
</script>

{% endblock %}